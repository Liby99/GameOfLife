<!DOCTYPE html>
<html>
    <head>
        <title>Game of Life</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script src="jquery.js"></script>
        <style>
            body {
                margin-left: auto;
                margin-right: auto;
                padding: 0 0 30px 0;
                width: 750px;
                text-align: center;
                background-color: rgba(30,30,30,1);
                color: rgba(235,235,235,1);
                font-family: 'Times New Roman';
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
            }
            
            section {
                width: 750px;
            }
            
            #page_header {
                font-size: 40px;
                margin-bottom: -10px;
            }
            
            #content p {
                text-align: left;
            }
            
            canvas {
                display: block;
            }
            
            div {
                margin: 10px;
            }
            
            button {
                display: inline-block;
                margin: 10px;
                line-height: 30px;
                padding: 0 30px;
                background-color: #ffaeae;
                border: 0;
            }
            
            button:hover {
                background-color: #ff7272;
            }
            
            .slider {
                margin-left: auto;
                margin-right: auto;
                padding: 0;
                width: 300px;
                height: 30px;
            }
            
            .slider .bar {
                position: relative;
                margin: 14px 0;
                width: 300px;
                height: 2px;
                background-color: #aaa;
            }
            
            .slider .handle {
                position: absolute;
                margin-top: -23px;
                margin-left: 143px;
                width: 15px;
                height: 15px;
                border-radius: 50%;
                background-color: #ffaeae;
            }
            
            .slider .handle:hover {
                background-color: #ff7272;
            }
            
            #links a {
                color: #fff;
                display: block;
            }
            
            #option_toggle, #close_option {
                position: fixed;
                top: 10px;
                right: 20px;
                font-size: 20px;
                cursor: pointer;
            }
            
            #option_panel {
                transition: all 0.3s;
                position: fixed;
                margin: 0;
                top: 0;
                right: -100%;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.6);
                text-align: center;
                overflow-y: scroll;
            }
            
            #option_panel.active {
                right: 0%;
            }
            
            #option_panel section {
                margin-left: auto;
                margin-right: auto;
            }
        </style>
    </head>
    <body>
        <div id="option_toggle">
            <span>OPTIONS</span>
        </div>
        <div id="option_panel">
            <div id="close_option">
                <span>CLOSE</span>
            </div>
            <section id="control_panel">
                <div id="animation_control">
                    <h2>Animation Control</h2>
                    <hr />
                    <button id="start">Start</button>
                    <button id="pause">Pause</button>
                    <button id="restart">Restart</button>
                    <button id="clear">Clear</button>
                    <div>
                        <label>
                            <span>Speed Slider: </span>
                            <span id="speed_label"></span>
                            <span>fps</span>
                        </label>
                        <div class="slider">
                            <div class="bar" id="speed_bar"></div>
                            <div class="handle" id="speed_handle"></div>
                        </div>
                    </div>
                </div>
                <div id="parameter_control">
                    <h2>Parameter Control</h2>
                    <hr />
                    <p>These parameters will give the rule of when the cell could born or die</p>
                    <label>Born: </label>
                    <input type="number" id="born" />
                    <label>Survive: </label>
                    <input type="number" id="survive" />
                </div>
                <div id="initiation_control">
                    <p>You can adjust the zoom in level by adjusting the size of each cell</p>
                    <label>Birth Rate: </label>
                    <input type="number" id="probability" />
                    <label>Cell Size: </label>
                    <input type="number" id="size" />
                </div>
                <div id="painting_control">
                    <h2>Edit Tool</h2>
                    <hr />
                    <p>You can click on the board to draw live cells.</p>
                    <p>When the Erase radio is selected, you can erace the live cells also.</p>
                    <input type="radio" name="painting" value="true" checked="checked">Paint
                    <input type="radio" name="painting" value="false">Erase
                </div>
            </section>
            <section>
                <div>
                    <h2>Interesting Presets</h2>
                    <hr />
                </div>
                <div>
                    <p>Click on any of these buttons to generate a preset on the preset location.</p>
                    <p>You can adjust the preset location in the lower part of this page.</p>
                    <p>Better created when the screen is cleared and paused.</p>
                    <h3>Still Lifes</h3>
                    <p>Lifes that stay still</p>
                    <div>
                        <button class="preset_btn" id="preset_block">Block</button>
                        <button class="preset_btn" id="preset_beehive">Beehive</button>
                        <button class="preset_btn" id="preset_loaf">Loaf</button>
                        <button class="preset_btn" id="preset_boat">Boat</button>
                    </div>
                    <h3>Oscillators</h3>
                    <p>Lifes that animate with a certain period</p>
                    <div>
                        <button class="preset_btn" id="preset_blinker">Blinker</button>
                        <button class="preset_btn" id="preset_toad">Toad</button>
                        <button class="preset_btn" id="preset_beacon">Beacon</button>
                        <button class="preset_btn" id="preset_pulsar">Pulsar</button>
                        <button class="preset_btn" id="preset_pentadecathlon">Pentadecathlon</button>
                        <button class="preset_btn" id="preset_galaxy">Galaxy</button>
                        <button class="preset_btn" id="preset_octagon">Octagon</button>
                    </div>
                    <h3>Spaceships</h3>
                    <p>Lifes that can move toward a direction</p>
                    <div>
                        <button class="preset_btn" id="preset_glider">Glider</button>
                        <button class="preset_btn" id="preset_lwss">Lightweight Spaceship</button>
                    </div>
                    <h3>Gosper's Glider Gun</h3>
                    <p>****** TRY ME! and see what will happen! ******</p>
                    <div>
                        <button class="preset_btn" id="preset_glider_gun">Gosper's Glider Gun</button>
                    </div>
                    <h3>Preset Position</h3>
                    <div>
                        <label>x: </label>
                        <input id="preset_x" type="number" />
                        <label>y: </label>
                        <input id="preset_y" type="number" />
                    </div>
                </div>
            </section>
            <section id="links">
                <div>
                    <h2>Useful Links</h2>
                    <hr />
                </div>
                <div>
                    <p>The links below can lead to lots of details and information of the Game of Life</p>
                    <p>I extremely want to make the OTCA Metapixel come to live! Could anyone help me on this?</p>
                    <a target="_blank" href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway's Game of Life on Eng Wikipedia</a>
                    <a target="_blank" href="https://ja.wikipedia.org/wiki/%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B2%E3%83%BC%E3%83%A0">ライフゲーム on Jap Wikipedia</a>
                    <a target="_blank" href="https://en.wikipedia.org/wiki/Cellular_automaton">Cellular Automation</a>
                    <a target="_blank" href="https://en.wikipedia.org/wiki/Turing_completeness">Turing Completeness</a>
                    <a target="_blank" href="http://www.conwaylife.com/wiki/OTCA_metapixel">OTCA Metapixel</a>
                    <a target="_blank" href="http://www.nicovideo.jp/watch/sm19509968">OTCA Metapixel ライフゲームの世界</a>
                </div>
            </section>
            <section id="contact">
                <div>
                    <h2>Contact & Info</h2>
                    <hr />
                </div>
                <div>
                    <p style="font-weight: bold">Liby Lee</p>
                    <p>Programmer & Designer</p>
                    <p>Email: liby99@icloud.com</p>
                    <p>This program is only for study use. It is open source and you can use it anyway you want. No certification is needed. I really hope this could help you! </p>
                    <p>このプログラムはただ勉強のためなので、開源のプログラムです。自由に使ってください。なんの建議があるなら、E-mailしでください。ありがとうございます〜</p>
                </div>
            </section>
        </div>
        <section id="title">
            <div>
                <h1 id="page_header">Game Of Life</h1>
                <p>Program by Liby Lee</p>
                <hr />
            </div>
        </section>
        <section id="content">
            <canvas width="750" height="750" id="game_of_life"></canvas>
            <p>
                <span>Step Count: </span>
                <span id="count">0</span>
            </p>
            <p>
                <span>Status: </span>
                <span id="status">On Going</span>
            </p>
        </section>
        
    </body>
    <script>
        
        var size = 3; //像素大小
        var probability = 0.5; //出生率
        var painting = true; //是否是绘制模式。false的话是擦除模式
        var frequency = 20; //Hz数
        var born = 3; //死细胞周围有多少个活细胞的时候会重生
        var survive = 2; //活细胞周围有多少个活细胞的时候会继续生存
        var content = null; //游戏的主要内容，一个boolean类型的二维数组，储存每个细胞的状态，true为生，false为死
        
        var draggingSlider = false;
        var running = true;
        
        var presetX = 20;
        var presetY = 20;
        
        var canvas = document.getElementById("game_of_life");
        var ctx = null;
        var timer = null;
        
        //使用随机函数初始化整个游戏
        function initiateGame () {
            randomize();
        };
        
        //遍历所有细胞并给每个细胞赋随机值
        function randomize() {
            for (var i = 0; i < content.length; i++) {
                for (var j = 0; j < content[i].length; j++) {
                    content[i][j] = (Math.random() < probability);
                }
            }
        }
        
        //遍历所有细胞，将所有细胞设置为死
        function fillDead () {
            for (var i = 0; i < content.length; i++) {
                for (var j = 0; j < content[i].length; j++) {
                    content[i][j] = false;
                }
            }
        }
        
        //遍历所有细胞，将所有细胞设置为生
        function fillLive () {
            for (var i = 0; i < content.length; i++) {
                for (var j = 0; j < content[i].length; j++) {
                    content[i][j] = true;
                }
            }
        };
        
        //获取细胞周围（8个）的活着的细胞数量
        function getNeighborAmount (i, j) {
            var count = 0;
            for (var a = i - 1; a <= i + 1; a++) {
                for (var b = j - 1; b <= j + 1; b++) {
                    if (inRange(a, b) && !(a == i && b == j) && content[a][b]) {
                        count++;
                    }
                }
            }
            return count;
        }
        
        //查看i, j是否越界
        function inRange (i, j) {
            return i >= 0 && i < content.length && j >= 0 && j < content[i].length;
        }
        
        //每一刻执行的函数。先处理content，再渲染所有图形，再更新count标签
        function loop () {
            process();
            render();
            count();
        }
        
        //将整个游戏世界清回初始状态
        function clear () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        //暂停进程
        function stop () {
            clearInterval(timer);
            $("#status").text("Paused");
            running = false;
        }
        
        //开始进程（不一定是重新开始
        function start () {
            $("#status").text("On Going");
            timer = setInterval(loop, 1000 / frequency);
            running = true;
        }
        
        //遍历所有细胞，处理下一回合中的所有细胞的状态
        function process () {
            var clone = new Array(content.length);
            for (var i = 0; i < content.length; i++) {
                clone[i] = new Array(content[i].length);
                for (var j = 0; j < content.length; j++) {
                    clone[i][j] = getNewStatus(i, j);
                }
            }
            content = clone;
        }
        
        //根据细胞周围活着细胞的数量来确定之后的状态
        function getNewStatus(i, j) {
            var neighbor = getNeighborAmount(i, j);
            if (neighbor < survive) {
                return false;
            }
            else if(neighbor == survive) {
                return content[i][j];
            }
            else if (neighbor == born) {
                return true;
            }
            else {
                return false;
            }
        }
        
        //清除上一个图像，根据content渲染下一帧图像
        function render () {
            clear();
            for (var i = 0; i < canvas.height / size; i++) {
                for (var j = 0; j < canvas.width / size; j++) {
                    if (content[i][j]) {
                        ctx.fillStyle = "#eaeaea";
                        ctx.fillRect(i * size, j * size, size - 0.5, size - 0.5);
                    }
                }
            }
        }
        
        //开始整个游戏，初始化content二维数组，初始化游戏参数，开始游戏
        function run () {
            ctx = canvas.getContext("2d");
            content = new Array();
            for (var i = 0; i < canvas.height / size; i++) {
                content[i] = new Array();
                for (var j = 0; j < canvas.width / size; j++) {
                    content[i][j] = false;
                }
            }
            initiateGame();
            start();
            running = true;
        }
        
        function setSpeed (s) {
            frequency = s;
            clearInterval(timer);
            $("#speed_label").text(Math.floor(frequency));
            if (running) {
                pause = 1000 / frequency;
                timer = setInterval(loop, pause);
            }
        }
        
        //更新Step Count
        function count() {
            $("#count").text(parseInt($("#count").text()) + 1);
        }
        
        //将Step Count清零
        function clearCount() {
            $("#count").text(0);
        }
        
        function preset (item) {
            switch (item) {
                case "block":
                    for (var i = 0; i < 2; i++) {
                        for (var j = 0; j < 2; j++) {
                            put(i, j);
                        }
                    }
                    break;
                case "beehive":
                    for (var i = 0; i < 4; i++) {
                        for (var j = 0; j < 3; j++) {
                            var b1 = i == 0 && j == 0;
                            var b2 = i == 3 && j == 0;
                            var b3 = i == 0 && j == 2;
                            var b4 = i == 3 && j == 2;
                            var b5 = i == 1 && j == 1;
                            var b6 = i == 2 && j == 1;
                            if (!(b1 || b2 || b3 || b4 || b5 || b6)) {
                                put(i, j);
                            }
                        }
                    }
                    break;
                case "loaf":
                    put(1, 0);
                    put(2, 0);
                    put(0, 1);
                    put(3, 1);
                    put(1, 2);
                    put(3, 2);
                    put(2, 3);
                    break;
                case "boat":
                    put(0, 0);
                    put(1, 0);
                    put(0, 1);
                    put(2, 1);
                    put(1, 2);
                    break;
                case "blinker":
                    for (var i = 0; i < 3; i++) {
                        put(i, 0);
                    }
                    break;
                case "toad":
                    for (var i = 1; i < 4; i++) {
                        put(i, 0);
                    }
                    for (var i = 0; i < 3; i++) {
                        put(i, 1);
                    }
                    break;
                case "beacon":
                    for (var i = 0; i < 4; i++) {
                        for (var j = 0; j < 4; j++) {
                            if ((i < 2 && j < 2) || (i >= 2 && j >= 2)) {
                                put(i, j);
                            }
                        }
                    }
                    break;
                case "pulsar":
                    for (var i = 0; i < 13; i++) {
                        for (var j = 0; j < 13; j++) {
                            if (j == 0 || j == 5 || j == 7 || j == 12) {
                                if ((i >= 2 && i <= 4) || (i >= 8 && i <= 10)) {
                                    put(i, j);
                                }
                            }
                            else if ((j >= 2 && j <= 4) || (j >= 8 && j <= 10)) {
                                if (i == 0 || i == 5 || i == 7 || i == 12) {
                                    put(i, j);
                                }
                            }
                        }
                    }
                    break;
                case "pentadecathlon":
                    for (var i = 0; i < 3; i++) {
                        for (var j = 0; j < 8; j++) {
                            if (!(i == 1 && (j == 1 || j == 6))) {
                                put(i, j);
                            }
                        }
                    }
                    break;
                case "glider":
                    put(1, 0);
                    put(2, 1);
                    for (var i = 0; i < 3; i++) {
                        put(i, 2);
                    }
                    break;
                case "lwss":
                    put(0, 0);
                    put(3, 0);
                    put(0, 2);
                    put(1, 3);
                    put(2, 3);
                    put(3, 3);
                    put(4, 3);
                    put(4, 2);
                    put(4, 1);
                    break;
                case "glider_gun":
                    put(0, 5);
                    put(0, 6);
                    put(1, 5);
                    put(1, 6);
                    put(10, 5);
                    put(10, 6);
                    put(10, 7);
                    put(11, 4);
                    put(11, 8);
                    put(12, 3);
                    put(12, 9);
                    put(13, 3);
                    put(13, 9);
                    put(14, 6);
                    put(15, 4);
                    put(15, 8);
                    put(16, 5);
                    put(16, 6);
                    put(16, 7);
                    put(17, 6);
                    put(20, 3);
                    put(20, 4);
                    put(20, 5);
                    put(21, 3);
                    put(21, 4);
                    put(21, 5);
                    put(22, 2);
                    put(22, 6);
                    put(24, 1);
                    put(24, 2);
                    put(24, 6);
                    put(24, 7);
                    put(34, 3);
                    put(34, 4);
                    put(35, 3);
                    put(35, 4);
                    break;
                case "galaxy":
                    for (var i = 0; i < 2; i++) {
                        for (var j = 0; j < 6; j++) {
                            put(i, j);
                        }
                    }
                    for (var i = 3; i < 9; i++) {
                        for (var j = 0; j < 2; j++) {
                            put(i, j);
                        }
                    }
                    for (var i = 7; i < 9; i++) {
                        for (var j = 3; j < 9; j++) {
                            put(i, j);
                        }
                    }
                    for (var i = 0; i < 6; i++) {
                        for (var j = 7; j < 9; j++) {
                            put(i, j);
                        }
                    }
                    break;
                case "octagon":
                    for (var i = 0; i < 8; i++) {
                        for (var j = 0; j < 8; j++) {
                            if (i + j == 3 || i - j == 4 || j - i == 4 || i + j == 11) {
                                put(i, j);
                            }
                        }
                    } 
                    break;
            }
        }
        
        function put(i, j) {
            content[presetX + i][presetY + j] = true;
        }
        
        //初始化窗口数据及Event Handler
        function initiateWindow () {
            //初始化调参部分的
            $("#game_of_life").css({"margin": ($(window).width - canvas.width) / 2});
            $("#born").val(born);
            $("#survive").val(survive);
            $("#probability").val(probability);
            $("#size").val(size);
            $("#speed_label").text(Math.floor(frequency));
            $("#preset_x").val(presetX);
            $("#preset_y").val(presetY);

            //暂停按钮
            $("#pause").click(function (event) {
                stop();
            });
            
            //开始按钮
            $("#start").click(function (event) {
                if (!running) {
                    start();
                    toggleOption();
                }
            });

            //重启按钮
            $("#restart").click(function (event) {
                stop();
                clearCount();
                run();
                toggleOption();
            });
            
            //清空按钮
            $("#clear").click(function (event) {
                stop();
                clearCount();
                fillDead();
                render();
            });
            
            //更改born和survive规则
            $("#born, #survive").change(function () {
                born = $("#born").val();
                survive = $("#survive").val();
            });
            
            //更改出生率
            $("#probability").change(function () {
                probability = $("#probability").val();
            });

            //更改像素大小
            $("#size").change(function () {
                size = $(this).val();
                render();
            });
            
            $("#preset_x, #preset_y").change(function () {
                presetX = parseInt($("#preset_x").val());
                presetY = parseInt($("#preset_y").val());
            });
            
            //切换编辑工具
            $("input[name=painting]").click(function (event) {
                if ($(this).val() == "true") {
                    painting = true;
                }
                else {
                    painting = false;
                }
                toggleOption();
            });
            
            //点击游戏界面的时候，根据当前编辑工具（绘制或擦除）来决定绘制或擦除点击位置的细胞。
            $("#game_of_life").click(function (event) {
                stop();
                var i = Math.floor(event.offsetX / size);
                var j = Math.floor(event.offsetY / size);
                content[i][j] = painting;
                render();
            });
            
            $("#speed_handle").mousedown(function (event) {
                draggingSlider = true;
            });
            
            $(window).mousemove(function (event) {
                if (draggingSlider) {
                    var handle = $("#speed_handle");
                    var container = handle.parent();
                    var margin = container.offset().left;
                    var x;
                    if (event.pageX - margin < 0) {
                        x = 0;
                    }
                    else if (event.pageX - margin < container.width()) {
                        x = event.pageX - margin;
                    }
                    else {
                        x = container.width();
                    }
                    handle.css({"margin-left": x - 7 + "px"});
                    
                    var percentage = x / 300;
                    setSpeed(2 + 40 * percentage);
                }
            });
            
            $(window).mouseup(function (event) {
                draggingSlider = false;
            });
            
            $("#option_toggle, #close_option").click(toggleOption);
        }
        
        function initiatePreset () {
            $(".preset_btn").click(function () {
                preset($(this).attr("id").substring(7));
                render();
            });
        }
        
        function toggleOption() {
            if ($("#option_panel").hasClass("active")) {
                $("#option_panel").removeClass("active");
            }
            else {
                $("#option_panel").addClass("active");
            }
        }
        
        function openOption() {
            $("#option_panel").addClass("active");
        }
        
        function closeOption() {
            $("#option_panel").removeClass("active");
        }
        
        //页面初始化函数
        $(function () {
            initiateWindow();
            initiatePreset();
            run();
        });
    </script>
</html>